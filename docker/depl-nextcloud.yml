---
- hosts: docker

  vars_prompt:
    - name: fqdn
      prompt: "Please enter your Nextcloud FQDN"

  tasks:
    - name: Create internal network
      community.docker.docker_network:
        name: nc-internal

    - name: Deploy NCDatabase
      community.docker.docker_container:
        name: NCDatabase
        image: mariadb:11
        volumes:
          - "nextcloud_NCMariaDB:/var/lib/mysql"
        env_file: /etc/docker-ansible/nextcloud/nc.env
        healthcheck:
          # If this fails or timeouts, the healthcheck fails.
          test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
          interval: 10s
          timeout: 10s
          retries: 5
          start_period: 190s
        restart_policy: on-failure
        networks:
          - name: nc-internal


    - name: Sleep for 30 seconds and continue with play
      ansible.builtin.wait_for:
        timeout: 30
      delegate_to: localhost

    - name: Deploy NCFrontend
      community.docker.docker_container:
        pull: "always"
        name: NCFrontend
        image: nextcloud:28
        volumes:
          - "nextcloud_NCData:/var/www/html"
        env_file: /etc/docker-ansible/nextcloud/nc.env
        labels:
          traefik.enable: "true"
          traefik.http.routers.nextcloud.entrypoints: "web"
          traefik.http.routers.nextcloud.rule: "Host(`{{fqdn}}`)"
          traefik.http.middlewares.https-redirect.redirectscheme.scheme: "https"
          traefik.http.routers.nextcloud.middlewares: "nc-header,https-redirect"
          traefik.http.routers.nextcloud-secure.entrypoints: "websecure"
          traefik.http.routers.nextcloud-secure.rule: "Host(`{{fqdn}}`)"
          traefik.http.middlewares.nc-rep.redirectregex.regex: "https://(.*)/.well-known/(card|cal)dav"
          traefik.http.middlewares.nc-rep.redirectregex.replacement: "https://$$1/remote.php/dav/"
          traefik.http.middlewares.nc-rep.redirectregex.permanent: "true"
          traefik.http.middlewares.nc-header.headers.customFrameOptionsValue: "SAMEORIGIN"
          traefik.http.middlewares.nc-header.headers.customResponseHeaders.Strict-Transport-Security: "15552000"
          traefik.http.routers.nextcloud-secure.middlewares: "nc-rep,nc-header"
          traefik.http.routers.nextcloud-secure.tls: "true"
          traefik.http.routers.nextcloud-secure.tls.certresolver: "cloudflare"
          traefik.http.routers.nextcloud-secure.service: "nextcloud"
          traefik.http.services.nextcloud.loadbalancer.server.port: "80"
          traefik.http.services.nextcloud.loadbalancer.passHostHeader: "true"
        networks:
          - name: exposed_web_network
          - name: nc-internal
